# -*- encoding: utf-8 -*-
#
# Copyright 2015 Red Hat, Inc.
#
# Licensed under the Apache License, Version 2.0 (the "License"); you may
# not use this file except in compliance with the License. You may obtain
# a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS, WITHOUT
# WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the
# License for the specific language governing permissions and limitations
# under the License.

---
- name: Ensure dependencies are installed
  package:
    name: '{{ item }}'
  with_items:
    - epel-release
    - yum-plugin-priorities
    - policycoreutils-python
    - "http://packages.distributed-ci.io/dci-release.el{{ ansible_distribution_major_version }}.noarch.rpm"
  tags:
    - dci-core

- name: Ensure dci-sshpubkeys is installed
  yum:
    name: dci-sshpubkeys
    state: present
  tags:
    - dci-core

- name: Add RDO Repository
  yum_repository:
    name: RDO-OpenStack
    description: RDO YUM repo
    baseurl: http://mirror.centos.org/centos/$releasever/cloud/$basearch/openstack-pike/
    exclude: python-zmq, zeromq
    gpgcheck: no
  tags:
    - dci-core

- name: Start chrony service if it exists
  service:
    name: chronyd
    state: started
    enabled: yes
  register: command_result
  failed_when: "command_result|failed and 'not find' not in command_result.msg"
  tags:
    - dci-core

- name: Set the server hostname
  hostname:
    name: '{{ ansible_ssh_host }}'
  tags:
    - dci-core

- name: Ensure SELinux is enforced
  selinux:
    state: enforcing
    policy: targeted
  tags:
    - dci-core

- name: Ensure packages are up to their latest release
  package:
    name: *
    state: latest
    update_cache: yes
    exclude: dci-api

- command: systemctl is-active firewalld
  register: firewalld
  tags:
    - dci-core
  ignore_errors: True
