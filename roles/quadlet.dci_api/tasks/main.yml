---
- name: HAProxy conf for dci-api
  block:
    - name: Load HAProxy role handlers
      ansible.builtin.import_role:
        name: quadlet.haproxy
        tasks_from: noop
        handlers_from: main

    - name: Render the HAproxy backend
      ansible.builtin.template:
        src: haproxy_backend.cfg.j2
        dest: "{{ haproxy_config_dir }}/10_backend_dci_api.cfg"
        mode: '0640'
      notify:
        - Reload haproxy

- name: Create container env directory
  ansible.builtin.file:
    path: /etc/dci-api/
    mode: '0750'
    state: directory

- name: Create container env configuration
  ansible.builtin.template:
    src: dci-api.env.j2
    dest: /etc/dci-api/dci-api.env
    mode: '0640'
  notify:
    - Restart dci-api

- name: Create the required amount of containers
  vars:
    _quadlet: dci-api
    _config: "{{ dci_api_container_spec }}"
  block:
    - name: Pull image
      containers.podman.podman_image:
        name: "{{ _config.image }}"
        force: true
      register: dci_api_container_pulled
      notify:
        - Restart dci-api

    - name: Ensure backup is made
      ansible.builtin.command: "{{ dci_db_backup_command }}"
      delegate_to: "{{ groups.dci_database | first }}"
      become: true
      become_user: "{{ yolo_backup_user | default('dci') }}"
      # Backups can take some time
      # To avoid ssh connection behaving badly (timeout, ansible not resuming after backup done)
      # we run as an async task, limiting it to 30 minutes and checking if it's done every 15 seconds
      async: 1800
      poll: 15
      changed_when: true
      when:
        - dci_db_backup_before_cs_upgrade | default(False)
        - dci_api_container_pulled.changed | defauilt(False)
      tags:
        - dci-core

    - name: Create container quadlet
      ansible.builtin.template:
        src: "global.container.j2"
        dest: "/etc/containers/systemd/{{ _quadlet }}@.container"
        mode: '0640'
      notify:
        - Restart dci-api

    - name: Ensure service is started
      ansible.builtin.systemd:
        name: "{{ _quadlet }}@{{ item }}.service"
        state: started
        daemon-reload: true
      ignore_errors: "{{ ansible_check_mode }}"
      loop: "{{ range(0, _config.scale) | list }}"

- name: Get count of configured containers
  vars:
    _quadlet: dci-api
  ansible.builtin.find:
    paths: /etc/containers/systemd/
    patterns: "{{ _quadlet }}@*.container"
    file_type: link
  register: _container_units_found

- name: Remove over-scale containers
  vars:
    _quadlet: dci-api
  when: _container_units_found.matched > dci_api_container_scale
  block:
    - name: Remove over-scale unit files
      ansible.builtin.file:
        dest: /etc/containers/systemd/{{ _quadlet }}@{{ item }}.quadlet
        state: absent
      loop: "{{ range(dci_api_container_scale, _container_units_found.matched) | list }}"

    - name: Stop over-scale services
      ansible.builtin.systemd:
        name: "{{ _quadlet }}@{{ item }}.service"
        state: stopped
        daemon-reload: true
      ignore_errors: "{{ ansible_check_mode }}"
      loop: "{{ range(dci_api_container_scale, _container_units_found.matched) | list }}"
...
